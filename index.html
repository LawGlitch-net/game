<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meow Meow - Cat Path Game</title>
    <style>
        * { box-sizing: border-box; }
        
        :root {
            --bg: #fff0f5;
            --bg-secondary: #ffe8f0;
            --grid: #ddb5c9;
            --p1: #ff66b2;
            --p2: #ff9933;
            --wall: #c85a75;
            --text: #5c3a47;
            --text-dim: #8b6b7b;
            --border: #d4a5b5;
        }
        
        body {
            font-family: 'Comic Sans MS', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #ffd9e8 100%);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 12px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        h1 {
            margin: 15px 0;
            font-size: clamp(2em, 6vw, 3em);
            color: var(--p1);
            font-weight: 900;
            text-shadow: 2px 2px 8px rgba(255, 102, 178, 0.3);
            letter-spacing: 2px;
        }
        
        /* CONNECTION UI */
        #setup {
            background: linear-gradient(135deg, #fff5fa 0%, #fff0f5 100%);
            padding: clamp(15px, 4vw, 25px);
            border-radius: 16px;
            border: 3px solid var(--border);
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(255, 102, 178, 0.2);
        }
        
        #setup h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--p1);
            font-size: clamp(1.2em, 4vw, 1.5em);
            text-align: center;
        }
        
        #setup-start {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        #setup-start p {
            text-align: center;
            color: var(--text-dim);
            margin: 0 0 10px 0;
        }
        
        #setup-start button {
            padding: 14px 20px;
            font-size: clamp(0.9em, 2vw, 1em);
        }
        
        .step {
            margin-bottom: 20px;
            padding: 15px;
            border-left: 4px solid var(--p1);
            border-radius: 8px;
            background: rgba(255, 102, 178, 0.1);
        }
        
        .step p {
            margin: 0 0 10px 0;
            font-size: clamp(0.85em, 2vw, 0.95em);
            color: var(--text-dim);
        }
        
        textarea {
            width: 100%;
            height: 70px;
            background: #fff;
            color: #333;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 11px;
            resize: none;
            padding: 10px;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
        }
        
        button {
            cursor: pointer;
            padding: clamp(10px, 2vw, 12px) clamp(16px, 3vw, 24px);
            background: linear-gradient(135deg, #ff7fc9 0%, #ff99d8 100%);
            color: white;
            border: 2px solid var(--p1);
            border-radius: 10px;
            font-weight: 700;
            font-size: clamp(0.85em, 2vw, 0.95em);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(255, 102, 178, 0.3);
        }
        
        button:hover {
            background: linear-gradient(135deg, #ff66b2 0%, #ff88cc 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 102, 178, 0.4);
        }
        
        button.primary {
            background: linear-gradient(135deg, var(--p1) 0%, #ff88cc 100%);
            color: white;
            border-color: #ff3385;
        }
        
        button.primary:hover {
            background: linear-gradient(135deg, #ff4da6 0%, #ff99d8 100%);
            box-shadow: 0 6px 20px rgba(255, 102, 178, 0.5);
        }
        
        .hidden { display: none !important; }
        
        /* GAME BOARD CONTAINER */
        #game-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
        }
        
        #status-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(90deg, rgba(255, 102, 178, 0.2) 0%, rgba(255, 153, 51, 0.2) 100%);
            border-radius: 12px;
            border: 2px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        #status {
            font-size: clamp(1em, 3vw, 1.3em);
            font-weight: bold;
            flex: 1;
        }
        
        #turn-indicator {
            color: var(--p1);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 900;
        }
        
        .wall-counter {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border: 2px solid currentColor;
            font-size: clamp(0.85em, 2vw, 0.95em);
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .wall-counter.p1 {
            color: var(--p1);
        }
        
        .wall-counter.p2 {
            color: var(--p2);
        }
        
        .instructions {
            text-align: center;
            color: var(--text);
            font-size: clamp(0.8em, 2vw, 0.9em);
            margin-bottom: 15px;
            line-height: 1.5;
            font-weight: 600;
        }
        
        /* GAME BOARD */
        #board {
            display: inline-grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: clamp(3px, 1.2vw, 6px);
            background: linear-gradient(135deg, #fff5fa 0%, #ffe8f0 100%);
            padding: clamp(12px, 2.5vw, 18px);
            border: 4px solid var(--border);
            border-radius: 16px;
            position: relative;
            width: 100%;
            max-width: 520px;
            aspect-ratio: 1;
            box-shadow: 0 8px 32px rgba(255, 102, 178, 0.15), inset 0 0 20px rgba(255, 255, 255, 0.6);
        }
        
        .cell {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, #fff8fc 0%, #fff2f7 100%);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            border: 2px solid var(--grid);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cell:hover {
            background: linear-gradient(135deg, #ffe8f5 0%, #ffd9ed 100%);
            border-color: var(--p1);
            box-shadow: 0 0 8px rgba(255, 102, 178, 0.25);
        }
        
        .cell.valid-move {
            background: linear-gradient(135deg, rgba(255, 153, 51, 0.35) 0%, rgba(255, 102, 178, 0.25) 100%);
            border: 2px solid var(--p2);
            box-shadow: inset 0 0 8px rgba(255, 153, 51, 0.2), 0 0 12px rgba(255, 102, 178, 0.3);
        }
        
        /* PAWNS */
        .pawn {
            font-size: clamp(24px, 6vw, 40px);
            z-index: 10;
            filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.2));
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: move;
        }
        
        .pawn:hover {
            filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.3));
            transform: scale(1.15);
        }
        
        /* WALLS */
        .wall-block {
            grid-column: span 1;
            grid-row: span 1;
            background: linear-gradient(135deg, var(--wall) 0%, #d97a8f 100%);
            border: 2px solid #a83d5a;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(200, 90, 117, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.2);
            z-index: 5;
            position: relative;
        }
        
        /* GHOST WALLS */
        .gap-h, .gap-v {
            position: absolute;
            background: transparent;
            z-index: 20;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.12s ease;
        }
        
        .gap-h:hover, .gap-v:hover {
            background: rgba(255, 153, 51, 0.5);
            border: 2px dashed var(--p2);
        }
        
        #connection-status {
            color: var(--text-dim);
            margin-top: 10px;
            font-size: clamp(0.85em, 2vw, 0.95em);
            text-align: center;
            font-weight: 600;
        }
        
        #connection-status.error {
            color: #c85a75;
            font-weight: 700;
        }
        
        #connection-status.success {
            color: #ff9933;
            font-weight: 700;
        }
        
        /* WALL CONTROLLER */
        #wall-controller {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(255, 102, 178, 0.15) 0%, rgba(255, 153, 51, 0.15) 100%);
            border-radius: 12px;
            border: 2px solid var(--border);
            text-align: center;
        }
        
        #wall-controller.active {
            display: block;
        }
        
        #wall-controller h3 {
            margin: 0 0 10px 0;
            color: var(--wall);
            font-size: 1em;
        }
        
        .controller-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .controller-buttons button {
            padding: 10px 16px;
            font-size: 0.85em;
            min-width: 60px;
        }
        
        .controller-buttons button.rotate {
            background: linear-gradient(135deg, #ff9933 0%, #ffaa55 100%);
            border-color: #ff7700;
        }
        
        .controller-buttons button.deploy {
            background: linear-gradient(135deg, #66ff66 0%, #88ff88 100%);
            border-color: #33cc33;
            color: #000;
            font-weight: 900;
        }
        
        .controller-buttons button.cancel {
            background: linear-gradient(135deg, #cc6666 0%, #dd8888 100%);
            border-color: #aa3333;
        }
        
        .wall-preview {
            font-size: 0.9em;
            color: var(--text-dim);
            margin-top: 8px;
            font-weight: 600;
        }
        
        /* VICTORY MODAL */
        #victory-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        #victory-modal.active {
            display: flex;
        }
        
        #victory-content {
            background: linear-gradient(135deg, #fff5fa 0%, #ffe8f0 100%);
            padding: clamp(30px, 8vw, 50px);
            border-radius: 20px;
            border: 4px solid var(--p1);
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(255, 102, 178, 0.4);
            animation: victoryPopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes victoryPopIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        #victory-content h2 {
            font-size: clamp(2em, 8vw, 3.5em);
            margin: 0 0 20px 0;
            color: var(--p1);
            text-shadow: 2px 2px 8px rgba(255, 102, 178, 0.3);
        }
        
        #victory-content p {
            font-size: clamp(1.1em, 3vw, 1.5em);
            color: var(--text);
            margin: 15px 0;
            font-weight: 700;
        }
        
        #victory-content button {
            margin-top: 25px;
            padding: clamp(12px, 3vw, 16px) clamp(24px, 5vw, 32px);
            font-size: clamp(1em, 3vw, 1.2em);
        }
        
        @media (max-width: 600px) {
            body {
                padding: 8px;
            }
            
            #setup {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>

<h1>üê± Mitti Mitti üê±</h1>

<div id="setup">
    <h3>Choose Your Player</h3>
    <div id="setup-start">
        <p>Who will you be?</p>
        <button class="primary" onclick="initHost()">üò∏ Sunny Cat (Host)</button>
        <button onclick="initGuest()">üòª Happy Cat (Guest)</button>
    </div>

    <div id="host-flow" class="hidden">
        <div class="step">
            <p>üìã Step 1: Copy and share this code:</p>
            <textarea id="host-offer" readonly>Generating...</textarea>
            <button onclick="copyToClipboard('host-offer')">üìã Copy</button>
        </div>
        <div class="step">
            <p>üìã Step 2: Paste the code from your friend:</p>
            <textarea id="host-answer-input" placeholder="Paste friend's code here..."></textarea>
            <button class="primary" onclick="hostFinalize()">‚ñ∂Ô∏è Start</button>
        </div>
    </div>

    <div id="guest-flow" class="hidden">
        <div class="step">
            <p>üìã Step 1: Paste the code from your friend:</p>
            <textarea id="guest-offer-input" placeholder="Paste friend's code here..."></textarea>
            <button class="primary" onclick="guestProcessOffer()">‚öôÔ∏è Generate Code</button>
        </div>
        <div class="step hidden" id="guest-answer-step">
            <p>üìã Step 2: Copy and send this code:</p>
            <textarea id="guest-answer" readonly></textarea>
            <button onclick="copyToClipboard('guest-answer')">üìã Copy</button>
        </div>
    </div>
    
    <div id="connection-status"></div>
</div>

<div id="game-container" class="hidden">
    <div id="status-bar">
        <div id="status">Turn: <span id="turn-indicator">Sunny</span></div>
        <div class="wall-counter p1" id="walls-p1">üß± P1: 10</div>
        <div class="wall-counter p2" id="walls-p2">üß± P2: 10</div>
    </div>
    
    <div class="instructions">
        <div id="instructions-text">üëÜ Tap to move ‚Ä¢ üß± Click button to place walls</div>
    </div>
    
    <button id="place-wall-btn" onclick="startWallPlacement()" style="display: block; margin: 0 auto 15px; padding: 12px 24px; background: linear-gradient(135deg, #ff9933 0%, #ffaa55 100%); color: white; border: 2px solid #ff7700; border-radius: 10px; font-weight: 700; font-size: 0.95em; cursor: pointer; box-shadow: 0 4px 12px rgba(255, 153, 51, 0.3);">
        üß± Place Wall
    </button>
    
    <div id="wall-controller">
        <h3>üéÆ Wall Controller</h3>
        <div class="wall-preview" id="wall-preview">Horizontal ‚Ä¢ Position: (0,0)</div>
        <div class="controller-buttons">
            <button onclick="moveWall(-1, 0)">‚Üê Move Left</button>
            <button onclick="moveWall(1, 0)">Move Right ‚Üí</button>
            <button onclick="moveWall(0, -1)">‚Üë Move Up</button>
            <button onclick="moveWall(0, 1)">Move Down ‚Üì</button>
            <button class="rotate" onclick="rotateWall()">üîÑ Rotate</button>
            <button class="deploy" onclick="deployWall()">‚úì Deploy</button>
            <button class="cancel" onclick="cancelWallPlacement()">‚úï Cancel</button>
        </div>
    </div>
    
    <div id="board"></div>
</div>

<div id="victory-modal">
    <div id="victory-content">
        <h2 id="victory-emoji">üéâ</h2>
        <h2 id="victory-text">You Win!</h2>
        <p id="victory-message">Congratulations!</p>
        <button class="primary" onclick="location.reload()">‚ñ∂Ô∏è Play Again</button>
    </div>
</div>

<script>
const BOARD_SIZE = 9;

let state = {
    p1: { x: 4, y: 0, walls: 10 },
    p2: { x: 4, y: 8, walls: 10 },
    walls: [],
    turn: 1,
    myPlayerId: null
};

let wallPlacing = {
    active: false,
    cells: [],
    orientation: 'h'
};

let boardScaling = { cellSize: 40, gapSize: 10 };

window.addEventListener('resize', () => {
    if (!document.getElementById('setup').classList.contains('hidden') === false) {
        renderBoard();
    }
});

function hasPath(playerPos, targetRow, walls) {
    let queue = [playerPos];
    let visited = new Set();
    visited.add(`${playerPos.x},${playerPos.y}`);

    while (queue.length > 0) {
        let {x, y} = queue.shift();
        if (y === targetRow) return true;

        const moves = [{dx:0, dy:-1}, {dx:0, dy:1}, {dx:-1, dy:0}, {dx:1, dy:0}];

        for (let m of moves) {
            let nx = x + m.dx;
            let ny = y + m.dy;
            
            if (nx >= 0 && nx < 9 && ny >= 0 && ny < 9 && !visited.has(`${nx},${ny}`)) {
                if (!isBlocked(x, y, nx, ny, walls)) {
                    visited.add(`${nx},${ny}`);
                    queue.push({x: nx, y: ny});
                }
            }
        }
    }
    return false;
}

function isWallCell(x, y, walls) {
    for (let w of walls) {
        for (let cell of w.cells) {
            if (cell.x === x && cell.y === y) return true;
        }
    }
    return false;
}

function isBlocked(x1, y1, x2, y2, walls) {
    return isWallCell(x2, y2, walls);
}

function getValidMoves(playerPos, walls) {
    const moves = [];
    const directions = [{dx:0, dy:-1}, {dx:0, dy:1}, {dx:-1, dy:0}, {dx:1, dy:0}];
    
    for (let dir of directions) {
        const nx = playerPos.x + dir.dx;
        const ny = playerPos.y + dir.dy;
        
        if (nx >= 0 && nx < 9 && ny >= 0 && ny < 9) {
            if (!isBlocked(playerPos.x, playerPos.y, nx, ny, walls)) {
                moves.push({x: nx, y: ny});
            }
        }
    }
    return moves;
}

function startWallPlacement() {
    if (state.turn !== state.myPlayerId) return;
    const me = state.turn === 1 ? state.p1 : state.p2;
    if (me.walls <= 0) {
        alert("No walls left!");
        return;
    }
    wallPlacing.active = true;
    wallPlacing.cells = [{x: 4, y: 4}];
    wallPlacing.orientation = 'h';
    document.getElementById('wall-controller').classList.add('active');
    document.getElementById('place-wall-btn').style.display = 'none';
    updateWallPreview();
    renderBoard();
}

function moveWall(dx, dy) {
    const newCells = wallPlacing.cells.map(cell => ({
        x: Math.max(0, Math.min(8, cell.x + dx)),
        y: Math.max(0, Math.min(8, cell.y + dy))
    }));
    
    if (newCells.every(cell => cell.x >= 0 && cell.x <= 8 && cell.y >= 0 && cell.y <= 8)) {
        wallPlacing.cells = newCells;
    }
    updateWallPreview();
    renderBoard();
}

function rotateWall() {
    const baseCell = wallPlacing.cells[0];
    
    if (wallPlacing.orientation === 'h') {
        wallPlacing.cells = [{x: baseCell.x, y: baseCell.y}, {x: baseCell.x, y: baseCell.y + 1}];
        wallPlacing.orientation = 'v';
    } else {
        wallPlacing.cells = [{x: baseCell.x, y: baseCell.y}, {x: baseCell.x + 1, y: baseCell.y}];
        wallPlacing.orientation = 'h';
    }
    
    if (!wallPlacing.cells.every(cell => cell.x >= 0 && cell.x <= 8 && cell.y >= 0 && cell.y <= 8)) {
        wallPlacing.cells = [{x: baseCell.x, y: baseCell.y}];
    }
    
    updateWallPreview();
    renderBoard();
}

function updateWallPreview() {
    const typeStr = wallPlacing.orientation === 'h' ? 'Horizontal (1x2)' : 'Vertical (2x1)';
    const cellsStr = wallPlacing.cells.map(c => `(${c.x},${c.y})`).join(' + ');
    document.getElementById('wall-preview').innerText = `${typeStr} ‚Ä¢ Position: ${cellsStr}`;
}

function deployWall() {
    const me = state.turn === 1 ? state.p1 : state.p2;
    if (me.walls <= 0) {
        alert("No walls left!");
        return;
    }
    
    for (let cell of wallPlacing.cells) {
        if ((cell.x === state.p1.x && cell.y === state.p1.y) || (cell.x === state.p2.x && cell.y === state.p2.y)) {
            alert("Can't place wall on a cat!");
            return;
        }
    }
    
    const overlap = state.walls.some(w => {
        return w.cells.some(wCell => 
            wallPlacing.cells.some(pCell => pCell.x === wCell.x && pCell.y === wCell.y)
        );
    });

    if (overlap) {
        alert("Wall already there!");
        return;
    }

    const testWalls = [...state.walls, {cells: wallPlacing.cells, orientation: wallPlacing.orientation}];
    if (!hasPath(state.p1, 8, testWalls) || !hasPath(state.p2, 0, testWalls)) {
        alert("Can't block the path!");
        return;
    }

    sendMove({ type: 'WALL', cells: wallPlacing.cells, orientation: wallPlacing.orientation });
    cancelWallPlacement();
}

function cancelWallPlacement() {
    wallPlacing.active = false;
    document.getElementById('wall-controller').classList.remove('active');
    document.getElementById('place-wall-btn').style.display = 'block';
    renderBoard();
}

function renderBoard() {
    const board = document.getElementById('board');
    board.innerHTML = '';
    
    const wallCells = new Set();
    state.walls.forEach(w => {
        w.cells.forEach(cell => {
            wallCells.add(`${cell.x},${cell.y}`);
        });
    });
    
    const previewCells = new Set();
    if (wallPlacing.active) {
        wallPlacing.cells.forEach(cell => {
            previewCells.add(`${cell.x},${cell.y}`);
        });
    }

    for (let y = 0; y < 9; y++) {
        for (let x = 0; x < 9; x++) {
            const cellKey = `${x},${y}`;
            
            if (wallCells.has(cellKey)) {
                let wallBlock = document.createElement('div');
                wallBlock.className = 'wall-block';
                board.appendChild(wallBlock);
            } else if (previewCells.has(cellKey)) {
                let previewBlock = document.createElement('div');
                previewBlock.className = 'wall-block';
                previewBlock.style.opacity = '0.5';
                previewBlock.style.borderStyle = 'dashed';
                board.appendChild(previewBlock);
            } else {
                let d = document.createElement('div');
                d.className = 'cell';
                d.dataset.x = x;
                d.dataset.y = y;
                d.onclick = () => handleMoveClick(x, y);
                board.appendChild(d);
            }
        }
    }

    const validMoves = state.turn === state.myPlayerId 
        ? getValidMoves(state.turn === 1 ? state.p1 : state.p2, state.walls)
        : [];
    
    validMoves.forEach(m => {
        const cell = board.querySelector(`[data-x="${m.x}"][data-y="${m.y}"]`);
        if (cell) cell.classList.add('valid-move');
    });

    let p1Cell = board.querySelector(`[data-x="${state.p1.x}"][data-y="${state.p1.y}"]`);
    if (p1Cell) {
        let p1 = document.createElement('div');
        p1.className = 'pawn';
        p1.innerText = 'üò∏';
        p1.style.pointerEvents = 'none';
        p1Cell.appendChild(p1);
    }

    let p2Cell = board.querySelector(`[data-x="${state.p2.x}"][data-y="${state.p2.y}"]`);
    if (p2Cell) {
        let p2 = document.createElement('div');
        p2.className = 'pawn';
        p2.innerText = 'üòª';
        p2.style.pointerEvents = 'none';
        p2Cell.appendChild(p2);
    }
    
    updateStatus();
}

function renderWallGaps(board) {}

function updateStatus() {
    const ind = document.getElementById('turn-indicator');
    const playerName = state.turn === 1 ? "üò∏ Sunny" : "üòª Happy";
    let text = playerName;
    
    if(state.turn === state.myPlayerId) {
        text += " ‚≠ê YOUR TURN";
    }
    
    ind.innerText = text;
    ind.style.color = state.turn === 1 ? "var(--p1)" : "var(--p2)";
    
    document.getElementById('walls-p1').innerText = `üß± P1: ${state.p1.walls}`;
    document.getElementById('walls-p2').innerText = `üß± P2: ${state.p2.walls}`;
}

function handleMoveClick(x, y) {
    if (state.turn !== state.myPlayerId) return;

    const me = state.turn === 1 ? state.p1 : state.p2;
    const dist = Math.abs(me.x - x) + Math.abs(me.y - y);

    if (dist === 1 && !isBlocked(me.x, me.y, x, y, state.walls)) {
        sendMove({ type: 'MOVE', x, y });
    }
}



function showVictory(winner) {
    const modal = document.getElementById('victory-modal');
    const textEl = document.getElementById('victory-text');
    const messageEl = document.getElementById('victory-message');
    
    if (winner === 1) {
        textEl.innerText = 'üò∏ Sunny Cat Wins!';
        messageEl.innerText = 'The journey is complete!';
        document.getElementById('victory-emoji').innerText = 'üò∏';
    } else {
        textEl.innerText = 'üòª Happy Cat Wins!';
        messageEl.innerText = 'The journey is complete!';
        document.getElementById('victory-emoji').innerText = 'üòª';
    }
    
    modal.classList.add('active');
}

function applyMove(data) {
    if (data.type === 'MOVE') {
        let p = state.turn === 1 ? state.p1 : state.p2;
        p.x = data.x;
        p.y = data.y;
    } else if (data.type === 'WALL') {
        state.walls.push({ cells: data.cells, orientation: data.orientation });
        const me = state.turn === 1 ? state.p1 : state.p2;
        me.walls--;
        cancelWallPlacement();
    }
    
    if (state.p1.y === 8) {
        showVictory(1);
        return;
    }
    if (state.p2.y === 0) {
        showVictory(2);
        return;
    }

    state.turn = state.turn === 1 ? 2 : 1;
    renderBoard();
}

let pc, dataChannel;
const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

function initHost() {
    state.myPlayerId = 1;
    document.getElementById('setup-start').classList.add('hidden');
    document.getElementById('host-flow').classList.remove('hidden');

    pc = new RTCPeerConnection(config);
    dataChannel = pc.createDataChannel("game");
    setupChannel(dataChannel);

    pc.onicecandidate = e => {
        if (!e.candidate) {
            document.getElementById('host-offer').value = JSON.stringify(pc.localDescription);
        }
    };
    
    pc.createOffer().then(d => pc.setLocalDescription(d));
}

function hostFinalize() {
    try {
        const answer = JSON.parse(document.getElementById('host-answer-input').value);
        pc.setRemoteDescription(answer);
        setStatus("‚úÖ Connected!", "success");
    } catch (e) {
        setStatus("‚ùå Invalid code!", "error");
    }
}

function initGuest() {
    state.myPlayerId = 2;
    document.getElementById('setup-start').classList.add('hidden');
    document.getElementById('guest-flow').classList.remove('hidden');

    pc = new RTCPeerConnection(config);
    
    pc.ondatachannel = e => {
        setupChannel(e.channel);
    };

    pc.onicecandidate = e => {
        if (!e.candidate) {
            document.getElementById('guest-answer').value = JSON.stringify(pc.localDescription);
            document.getElementById('guest-answer-step').classList.remove('hidden');
        }
    };
}

function guestProcessOffer() {
    try {
        const offer = JSON.parse(document.getElementById('guest-offer-input').value);
        pc.setRemoteDescription(offer);
        pc.createAnswer().then(d => pc.setLocalDescription(d));
        setStatus("‚è≥ Waiting for friend...", "success");
    } catch (e) {
        setStatus("‚ùå Invalid code!", "error");
    }
}

function setStatus(msg, cls) {
    const el = document.getElementById('connection-status');
    el.innerText = msg;
    el.className = cls;
}

function setupChannel(channel) {
    channel.onopen = () => {
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game-container').classList.remove('hidden');
        renderBoard();
    };
    channel.onmessage = e => {
        const data = JSON.parse(e.data);
        applyMove(data);
    };
    dataChannel = channel;
}

function sendMove(moveData) {
    applyMove(moveData);
    dataChannel.send(JSON.stringify(moveData));
}

function copyToClipboard(id) {
    const el = document.getElementById(id);
    el.select();
    document.execCommand('copy');
    alert("‚úÖ Copied!");
}
</script>
</body>
</html>
